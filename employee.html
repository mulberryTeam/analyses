<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <!-- منع تكبير الشاشة على الهواتف -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
  <title>لوحة الموظف - نظام إدارة الأعمال</title>
  <!-- خطوط Google -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700" rel="stylesheet">
  <!-- أيقونات Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
  <style>
    /* خلفية الفيديو (غير تفاعلية) */
    #bgVideo {
      position: fixed;
      right: 0;
      bottom: 0;
      min-width: 100%;
      min-height: 100%;
      z-index: -1;
      object-fit: cover;
      pointer-events: none;
    }
    /* تغليف الصفحة مع position: relative */
    .page-wrapper {
      position: relative;
    }
    /* حاوية زر الترجمة: ستظهر فوق البطاقة بقليل */
    .lang-toggle-wrapper {
      position: absolute;
      top: -35px; /* اضبط القيمة حسب الحاجة */
      right: 20px;
      z-index: 1000;
    }
    .lang-toggle-btn {
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 8px 10px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
      font-size: 18px;
    }
    .lang-toggle-btn:hover {
      background: #2980b9;
      transform: scale(1.1);
    }
    /* قواعد عامة */
    body {
      font-family: 'Roboto', sans-serif;
      background: transparent;
      margin: 0;
      padding: 20px;
      transition: background 0.3s ease;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .header-left {
      display: flex;
      align-items: center;
    }
    .header-logo {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-left: 10px;
    }
    /* رسالة الترحيب باللون الأبيض */
    #employeeNameDisplay {
      color: #fff;
    }
    .logout-btn {
      padding: 8px 16px;
      background: #e74c3c;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      transition: transform 0.3s ease, background 0.3s ease;
    }
    .logout-btn:hover { 
      background: #c0392b;
      transform: scale(1.05);
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: rgba(255,255,255,0.95);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    /* ألسنة التنقل */
    .tab-nav {
      display: flex;
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
      overflow-x: auto;
    }
    .tab-nav button {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease;
    }
    .tab-nav button:hover { background: #f0f0f0; }
    .tab-nav button.active {
      border-bottom: 3px solid #3498db;
      font-weight: bold;
    }
    /* واجهة التحليلات - فلتر المبيعات */
    .filter-section {
      margin-bottom: 20px;
      padding: 20px;
      background: #f0f4f8;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s ease;
    }
    .filter-section:hover {
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    .filter-section label {
      margin-right: 10px;
      font-weight: 500;
    }
    .filter-section input {
      margin-right: 10px;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: border 0.3s ease;
    }
    .filter-section input:focus {
      border-color: #3498db;
      outline: none;
    }
    .filter-section button {
      padding: 8px 16px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .filter-section button:hover { 
      background: #2980b9;
      transform: scale(1.03);
    }
    /* بطاقة المبيعات */
    .sales-card {
      background: #f7f9fc;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      overflow-x: auto;
      transition: box-shadow 0.3s ease;
    }
    .sales-card:hover {
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    .sales-card table {
      width: 100%;
      border-collapse: collapse;
    }
    .sales-card th, .sales-card td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    .sales-card th { 
      background: #3498db; 
      color: #fff;
      font-weight: bold;
    }
    .sales-summary {
      margin-top: 15px;
      font-size: 16px;
      font-weight: bold;
    }
    /* واجهة المحادثة */
    .chat-top-bar {
      display: flex;
      align-items: center;
      background: #f1f1f1;
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }
    .chat-logo {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-left: 10px;
    }
    .mulberry-ceo {
      font-weight: bold;
      margin-right: 10px;
      background: linear-gradient(to right, blue, purple);
      -webkit-background-clip: text;
      color: transparent;
    }
    .chat-area {
      height: 400px;
      overflow-y: auto;
      background: rgba(255,255,255,0.8);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: height 0.3s ease;
    }
    .chat-bottom-bar {
      display: flex;
      padding: 10px;
      border-top: 1px solid #ddd;
    }
    .chat-bottom-bar input[type="text"] {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      margin-right: 10px;
      transition: border 0.3s ease;
    }
    .chat-bottom-bar input[type="text"]:focus {
      border-color: #3498db;
      outline: none;
    }
    .chat-bottom-bar button {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 20px;
      transition: transform 0.3s ease;
    }
    .chat-bottom-bar button:hover {
      transform: scale(1.1);
    }
    .chat-bubble {
      max-width: 70%;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
      position: relative;
      clear: both;
      word-wrap: break-word;
    }
    .chat-bubble.employee {
      background: #27ae60;
      color: #fff;
      margin-right: auto;
    }
    .chat-bubble.admin {
      background: #fff;
      color: #000;
      border: 1px solid #ddd;
      margin-left: auto;
      padding-left: 50px;
      position: relative;
    }
    .chat-bubble.admin .admin-name {
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }
    /* واجهة الإعدادات */
    .account-settings {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s ease;
    }
    .account-settings:hover {
      box-shadow: 0 6px 14px rgba(0,0,0,0.15);
    }
    .account-settings h3 { margin-top: 0; }
    .account-settings label {
      display: block;
      margin-top: 10px;
      font-weight: 500;
    }
    .account-settings input[type="text"],
    .account-settings input[type="password"],
    .account-settings input[type="file"] {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: border 0.3s ease;
    }
    .account-settings input:focus {
      border-color: #3498db;
      outline: none;
    }
    /* تحويل مدخل اسم المستخدم لأحرف صغيرة */
    #accUsername { text-transform: lowercase; }
    .account-settings button {
      margin-top: 15px;
      padding: 10px 20px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    .account-settings button:hover {
      background: #2980b9;
      transform: scale(1.03);
    }
    @media (max-width: 768px) {
      .container { padding: 20px; }
      .header { flex-direction: column; align-items: flex-start; }
      .logout-btn { width: 100%; text-align: center; }
      .chat-area { height: 200px; }
      .tab-nav button { font-size: 14px; }
    }
  </style>
</head>
<body>
  <!-- خلفية الفيديو (غير تفاعلية) -->
  <video autoplay muted loop id="bgVideo" playsinline disablePictureInPicture>
    <source src="https://cdn.dribbble.com/userupload/28774288/file/large-0f5d92145d706df70e061ebbf838fa27.mp4" type="video/mp4">
    متصفحك لا يدعم تشغيل الفيديو.
  </video>

  <!-- تغليف الصفحة -->
  <div class="page-wrapper">
    <!-- حاوية زر الترجمة (سيظهر فوق البطاقة بقليل) -->
    <div class="lang-toggle-wrapper">
      <button id="langToggle" class="lang-toggle-btn"><i class="fas fa-language"></i></button>
    </div>

    <div class="header">
      <div class="header-left">
        <img class="header-logo" id="employeePhotoDisplay" src="" alt="صورة الموظف">
        <h1 id="employeeNameDisplay">لوحة الموظف</h1>
      </div>
      <button class="logout-btn" id="logoutBtn">تسجيل الخروج</button>
    </div>
    <div class="container">
      <!-- ألسنة التنقل -->
      <div class="tab-nav">
        <button id="tabAnalyticsBtn" class="active">تحليلات</button>
        <button id="tabConversationBtn">المحادثة</button>
        <button id="tabSettingsBtn">الإعدادات</button>
      </div>
      
      <!-- واجهة التحليلات -->
      <div id="analytics" class="employee-tab">
        <div class="filter-section">
          <span id="filterLabel">تصفية المبيعات حسب:</span>
          <label id="radioDayLabel">
            <input type="radio" name="filterType" value="day" checked onclick="toggleFilterInputs('day')"> يوم
          </label>
          <label id="radioMonthLabel">
            <input type="radio" name="filterType" value="month" onclick="toggleFilterInputs('month')"> شهر
          </label>
          <label id="radioPeriodLabel">
            <input type="radio" name="filterType" value="period" onclick="toggleFilterInputs('period')"> فترة مخصصة
          </label>
          <div id="filterDay" style="margin-top:10px;">
            <input type="date" id="filterDayInput">
          </div>
          <div id="filterMonth" style="margin-top:10px; display:none;">
            <input type="month" id="filterMonthInput">
          </div>
          <div id="filterPeriod" style="margin-top:10px; display:none;">
            <label>من:</label>
            <input type="date" id="filterStartDate">
            <label>إلى:</label>
            <input type="date" id="filterEndDate">
          </div>
          <button onclick="loadSalesData()">تطبيق التصفية</button>
        </div>
        <h2 id="salesHeader">بيانات المبيعات والأرباح الخاصة بك</h2>
        <div id="salesData" class="sales-card">
          <!-- سيتم تحميل جدول المبيعات هنا -->
        </div>
        <div class="sales-summary" id="salesSummary"></div>
      </div>
      
      <!-- واجهة المحادثة -->
      <div id="conversation" class="employee-tab" style="display: none;">
        <div class="chat-top-bar">
          <img src="https://scontent.fjrs28-1.fna.fbcdn.net/v/t39.30808-6/471747354_122099892014715775_3226043878643219535_n.jpg?_nc_cat=106&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=NY9kpH5dCp8Q7kNvgFjPcDR&_nc_oc=AdichrKT9DoTy28yGZ98KDYMDPVCdiRNCf4QOJNrytAGaTcWPZbmjYDbg35UHLHA4eU&_nc_zt=23&_nc_ht=scontent.fjrs28-1.fna&_nc_gid=AFWUQlD-1ziVp7La0qO1Gkw&oh=00_AYBjZ96CDyy3OoXa7Nlt4mAmwqF7vNSoFSWYjC_2Li8VrQ&oe=67C83B25" class="chat-logo" alt="الشعار">
          <span id="chatHeader">التواصل مع الشركة الأم</span>
          <span class="mulberry-ceo">Mulberry-CEO</span>
        </div>
        <div class="chat-area">
          <div id="employeeChatMessages">
            <!-- سيتم تحميل رسائل المحادثة هنا -->
          </div>
        </div>
        <div class="chat-bottom-bar">
          <input type="text" id="employeeChatInput" placeholder="اكتب رسالتك...">
          <button onclick="sendEmployeeChatMessage()"><i class="send-icon">✈️</i></button>
        </div>
      </div>
      
      <!-- واجهة الإعدادات -->
      <div id="settings" class="employee-tab" style="display: none;">
        <div class="account-settings">
          <h3 id="settingsHeader">إعدادات الحساب</h3>
          <label id="usernameLabel" for="accUsername">تغيير اسم المستخدم:</label>
          <input type="text" id="accUsername" placeholder="اسم المستخدم الجديد" oninput="this.value = this.value.toLowerCase()">
          <label id="passwordLabel" for="accPassword">تغيير كلمة المرور:</label>
          <input type="password" id="accPassword" placeholder="كلمة المرور الجديدة">
          <label id="photoLabel" for="accPhoto">تغيير الصورة الشخصية:</label>
          <input type="file" id="accPhoto" accept="image/*">
          <button id="updateSettingsBtn" onclick="updateAccountSettings()">تحديث الإعدادات</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // منع الرجوع للخلف
      history.pushState(null, null, location.href);
      window.onpopstate = function () {
        history.go(1);
      };

      // تعريف اللغة والترجمات قبل استخدامها
      let currentLanguage = 'ar';
      const translations = {
        ar: {
          employeeDashboard: "لوحة الموظف",
          welcome: "أهلاً, ",
          logout: "تسجيل الخروج",
          tabAnalytics: "تحليلات",
          tabConversation: "المحادثة",
          tabSettings: "الإعدادات",
          filterLabel: "تصفية المبيعات حسب:",
          radioDay: "يوم",
          radioMonth: "شهر",
          radioPeriod: "فترة مخصصة",
          salesHeader: "بيانات المبيعات والأرباح الخاصة بك",
          tableHeaders: {
            product: "المنتج",
            original: "السعر الأصلي (₪)",
            sale: "سعر البيع (₪)",
            date: "التاريخ"
          },
          salesSummary: (totalSales, totalProfit) => `إجمالي المبيعات: ${totalSales} | إجمالي الأرباح: ₪${totalProfit}`,
          chatHeader: "التواصل مع الشركة الأم",
          supportName: "الدعم الفني",
          settingsHeader: "إعدادات الحساب",
          changeUsername: "تغيير اسم المستخدم:",
          changePassword: "تغيير كلمة المرور:",
          changePhoto: "تغيير الصورة الشخصية:",
          updateSettings: "تحديث الإعدادات",
          langToggle: "",
          chatInputPlaceholder: "اكتب رسالتك..."
        },
        en: {
          employeeDashboard: "Employee Dashboard",
          welcome: "Welcome, ",
          logout: "Logout",
          tabAnalytics: "Analytics",
          tabConversation: "Conversation",
          tabSettings: "Settings",
          filterLabel: "Filter Sales By:",
          radioDay: "Day",
          radioMonth: "Month",
          radioPeriod: "Custom Period",
          salesHeader: "Your Sales & Profit Data",
          tableHeaders: {
            product: "Product",
            original: "Original Price (₪)",
            sale: "Sale Price (₪)",
            date: "Date"
          },
          salesSummary: (totalSales, totalProfit) => `Total Sales: ${totalSales} | Total Profit: ₪${totalProfit}`,
          chatHeader: "Communication with Parent Company",
          supportName: "Technical Support",
          settingsHeader: "Account Settings",
          changeUsername: "Change Username:",
          changePassword: "Change Password:",
          changePhoto: "Change Personal Photo:",
          updateSettings: "Update Settings",
          langToggle: "",
          chatInputPlaceholder: "Type your message..."
        }
      };

      // التحقق من وجود بيانات تسجيل الدخول
      const employeeName = localStorage.getItem('employeeName');
      if (!employeeName) {
        alert("لم يتم العثور على جلسة الموظف. الرجاء تسجيل الدخول.");
        window.location.href = "index.html";
        return;
      }

      // إعداد Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyAi3_y7ugKB0cgzMV1-IVvbE2BwG_9RKSs",
        authDomain: "team-analysis-3c196.firebaseapp.com",
        databaseURL: "https://team-analysis-3c196-default-rtdb.firebaseio.com",
        projectId: "team-analysis-3c196",
        storageBucket: "team-analysis-3c196.firebasestorage.app",
        messagingSenderId: "38968485922",
        appId: "1:38968485922:web:667832a4aa77599ba8a6fb",
        measurementId: "G-853WkH2JK7"
      };
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();
      const storage = firebase.storage();

      // تحديث النصوص الثابتة في الصفحة
      function updateStaticTexts() {
        document.getElementById('employeeNameDisplay').textContent = translations[currentLanguage].welcome + employeeName;
        document.getElementById('logoutBtn').textContent = translations[currentLanguage].logout;
        document.getElementById('tabAnalyticsBtn').textContent = translations[currentLanguage].tabAnalytics;
        document.getElementById('tabConversationBtn').textContent = translations[currentLanguage].tabConversation;
        document.getElementById('tabSettingsBtn').textContent = translations[currentLanguage].tabSettings;
        document.getElementById('filterLabel').textContent = translations[currentLanguage].filterLabel;
        document.getElementById('radioDayLabel').innerHTML = `<input type="radio" name="filterType" value="day" checked onclick="toggleFilterInputs('day')"> ${translations[currentLanguage].radioDay}`;
        document.getElementById('radioMonthLabel').innerHTML = `<input type="radio" name="filterType" value="month" onclick="toggleFilterInputs('month')"> ${translations[currentLanguage].radioMonth}`;
        document.getElementById('radioPeriodLabel').innerHTML = `<input type="radio" name="filterType" value="period" onclick="toggleFilterInputs('period')"> ${translations[currentLanguage].radioPeriod}`;
        document.getElementById('salesHeader').textContent = translations[currentLanguage].salesHeader;
        document.getElementById('chatHeader').textContent = translations[currentLanguage].chatHeader;
        document.getElementById('settingsHeader').textContent = translations[currentLanguage].settingsHeader;
        document.getElementById('usernameLabel').textContent = translations[currentLanguage].changeUsername;
        document.getElementById('passwordLabel').textContent = translations[currentLanguage].changePassword;
        document.getElementById('photoLabel').textContent = translations[currentLanguage].changePhoto;
        document.getElementById('updateSettingsBtn').textContent = translations[currentLanguage].updateSettings;
        document.getElementById('employeeChatInput').setAttribute("placeholder", translations[currentLanguage].chatInputPlaceholder);
      }
      updateStaticTexts();

      // دالة لتبديل عرض مدخلات الفلترة
      window.toggleFilterInputs = function(type) {
        document.getElementById('filterDay').style.display = (type === 'day') ? 'block' : 'none';
        document.getElementById('filterMonth').style.display = (type === 'month') ? 'block' : 'none';
        document.getElementById('filterPeriod').style.display = (type === 'period') ? 'block' : 'none';
      };

      // تحميل صورة الموظف من قاعدة البيانات مع معامل لتجاوز الكاش
      function loadEmployeePhoto() {
        database.ref('employees').orderByChild('name').equalTo(employeeName).once('value')
        .then(snapshot => {
          let empPhoto = "";
          snapshot.forEach(child => { empPhoto = child.val().photo; });
          if (empPhoto) {
            document.getElementById('employeePhotoDisplay').src = empPhoto + '?t=' + new Date().getTime();
          } else {
            document.getElementById('employeePhotoDisplay').src = 'default-user.png';
          }
        });
      }
      loadEmployeePhoto();

      // تحميل بيانات المبيعات
      function loadSalesData() {
        database.ref('employees').orderByChild('name').equalTo(employeeName).once('value')
        .then(empSnapshot => {
          let employeeType = "regular";
          empSnapshot.forEach(child => { employeeType = child.val().type; });
          database.ref('sales').orderByChild('seller').equalTo(employeeName).once('value')
          .then(snapshot => {
            const salesData = snapshot.val() || {};
            let totalSales = 0;
            let totalProfit = 0;
            let tableHTML = `<table><tr>
              <th>${translations[currentLanguage].tableHeaders.product}</th>
              <th>${translations[currentLanguage].tableHeaders.original}</th>
              <th>${translations[currentLanguage].tableHeaders.sale}</th>
              <th>${translations[currentLanguage].tableHeaders.date}</th>
              </tr>`;
            const filterType = document.querySelector('input[name="filterType"]:checked').value;
            let filterFn = sale => true;
            if (filterType === "day") {
              const day = document.getElementById('filterDayInput').value;
              if (day) { filterFn = sale => sale.date.slice(0,10) === day; }
            } else if (filterType === "month") {
              const month = document.getElementById('filterMonthInput').value;
              if (month) { filterFn = sale => sale.date.startsWith(month); }
            } else if (filterType === "period") {
              const start = new Date(document.getElementById('filterStartDate').value);
              const end = new Date(document.getElementById('filterEndDate').value);
              if(document.getElementById('filterStartDate').value && document.getElementById('filterEndDate').value) {
                filterFn = sale => {
                  const saleDate = new Date(sale.date);
                  return saleDate >= start && saleDate <= end;
                };
              }
            }
            for (const key in salesData) {
              const sale = salesData[key];
              if (!filterFn(sale)) continue;
              totalSales++;
              const rawProfit = parseFloat(sale.salePrice) - parseFloat(sale.originalPrice);
              let percentage = 0.5;
              if (employeeType === "distinguished") {
                percentage = 0.7;
              } else if (employeeType === "regular") {
                // دالة لحساب نسبة البائع المميز
                percentage = getTopSellerRate(employeeName, sale.date);
              }
              totalProfit += rawProfit * percentage;
              tableHTML += `<tr>
                <td>${sale.productName}</td>
                <td>₪${sale.originalPrice}</td>
                <td>₪${sale.salePrice}</td>
                <td>${new Date(sale.date).toLocaleDateString()}</td>
              </tr>`;
            }
            tableHTML += "</table>";
            document.getElementById('salesData').innerHTML = tableHTML;
            document.getElementById('salesSummary').innerHTML = `<p>${translations[currentLanguage].salesSummary(totalSales, totalProfit.toFixed(2))}</p>`;
          });
        });
      }
      loadSalesData();

      // دالة لحساب نسبة البائع المميز
      function getTopSellerRate(empName, saleDate) {
        let rate = 0.5;
        database.ref('topSellerDesignations').once('value').then(snapshot => {
          const desData = snapshot.val() || {};
          for (const key in desData) {
            const des = desData[key];
            if (des.employee === empName) {
              const start = new Date(des.startDate);
              const end = new Date(des.endDate);
              const saleDt = new Date(saleDate);
              if (saleDt >= start && saleDt <= end) {
                rate = 0.6;
                break;
              }
            }
          }
        });
        return rate;
      }

      // تحميل رسائل المحادثة
      function loadEmployeeChatMessages() {
        database.ref('conversation').orderByChild('date').on('value', snapshot => {
          const messagesData = snapshot.val() || {};
          let chatHTML = "";
          for (const key in messagesData) {
            const msg = messagesData[key];
            if (msg.sender === "admin") {
              chatHTML += `<div class="chat-bubble admin">
                <span class="admin-name">${translations[currentLanguage].supportName}</span>
                <span>${msg.message}</span>
                <div style="font-size:10px;">${new Date(msg.date).toLocaleTimeString()}</div>
              </div>`;
            } else {
              chatHTML += `<div class="chat-bubble employee">
                <span>${msg.message}</span>
                <div style="font-size:10px; text-align:right;">${new Date(msg.date).toLocaleTimeString()}</div>
              </div>`;
            }
          }
          document.getElementById('employeeChatMessages').innerHTML = chatHTML;
          document.querySelector('.chat-area').scrollTop = document.querySelector('.chat-area').scrollHeight;
        });
      }
      loadEmployeeChatMessages();

      // إرسال رسالة المحادثة
      window.sendEmployeeChatMessage = function() {
        const input = document.getElementById('employeeChatInput');
        const text = input.value.trim();
        if (!text) return;
        const messageData = {
          sender: "employee",
          employeeUsername: localStorage.getItem('employeeUsername'),
          message: text,
          date: new Date().toISOString()
        };
        database.ref('conversation').push(messageData)
        .then(() => { input.value = ""; });
      };

      // تحديث إعدادات الحساب (بما في ذلك رفع الصورة وتحديثها في قاعدة البيانات)
      window.updateAccountSettings = function() {
        const newUsername = document.getElementById('accUsername').value.trim();
        const newPassword = document.getElementById('accPassword').value.trim();
        const fileInput = document.getElementById('accPhoto');
        database.ref('employees').orderByChild('name').equalTo(employeeName).once('value')
        .then(snapshot => {
          let empKey = null;
          snapshot.forEach(child => { empKey = child.key; });
          if (!empKey) return;
          let updates = {};
          if(newUsername) { updates.username = newUsername; }
          if(newPassword) { updates.password = newPassword; }
          if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const storageRef = storage.ref();
            const fileRef = storageRef.child('employee_photos/' + Date.now() + "_" + file.name);
            fileRef.put(file).then(() => {
              fileRef.getDownloadURL().then(photoURL => {
                updates.photo = photoURL;
                database.ref('employees/' + empKey).update(updates)
                .then(() => {
                  loadEmployeePhoto();
                  alert("تم تحديث إعدادات الحساب.");
                  fileInput.value = "";
                })
                .catch(error => {
                  alert("حدث خطأ أثناء تحديث البيانات: " + error.message);
                });
                database.ref('employeeAccounts').orderByChild('name').equalTo(employeeName).once('value')
                .then(snap => {
                  snap.forEach(child => {
                    child.ref.update({ 
                      username: newUsername || child.val().username, 
                      password: newPassword || child.val().password 
                    });
                  });
                });
              }).catch(error => {
                alert("حدث خطأ في تحديث الصورة: " + error.message);
              });
            }).catch(error => {
              alert("فشل تحميل الصورة: " + error.message);
            });
          } else {
            database.ref('employees/' + empKey).update(updates)
            .then(() => {
              alert("تم تحديث إعدادات الحساب.");
            });
            database.ref('employeeAccounts').orderByChild('name').equalTo(employeeName).once('value')
            .then(snap => {
              snap.forEach(child => {
                child.ref.update({ 
                  username: newUsername || child.val().username, 
                  password: newPassword || child.val().password 
                });
              });
            });
          }
        });
      };

      // تبديل عرض الألسنة (تبويب الواجهة)
      function showEmployeeTab(tabName) {
        const tabs = document.querySelectorAll('.employee-tab');
        tabs.forEach(tab => tab.style.display = 'none');
        document.getElementById(tabName).style.display = 'block';
      }
      document.getElementById('tabAnalyticsBtn').addEventListener('click', function(e) {
        showEmployeeTab('analytics');
        setActiveTab(e.target);
      });
      document.getElementById('tabConversationBtn').addEventListener('click', function(e) {
        showEmployeeTab('conversation');
        setActiveTab(e.target);
      });
      document.getElementById('tabSettingsBtn').addEventListener('click', function(e) {
        showEmployeeTab('settings');
        setActiveTab(e.target);
      });
      function setActiveTab(button) {
        const btns = document.querySelectorAll('.tab-nav button');
        btns.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
      }

      // تبديل اللغة
      window.toggleLanguage = function() {
        currentLanguage = currentLanguage === 'ar' ? 'en' : 'ar';
        updateStaticTexts();
        loadSalesData();
        loadEmployeeChatMessages();
      };

      // تسجيل الخروج
      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.clear();
        window.location.href = "index.html";
      });
    });
  </script>
</body>
</html>
